<!-- Toast para mensajes -->
<p-toast />

<p-toolbar styleClass="mb-6">
    <ng-template pTemplate="start">
        <h5 class="m-0 mr-4">Lista de Solicitudes</h5>
        <p-button label="Nueva Solicitud" icon="pi pi-plus" severity="secondary" class="mr-2" (click)="openNew()" />
    </ng-template>

    <ng-template pTemplate="end">
        <p-button label="Exportar" icon="pi pi-upload" severity="secondary" />
    </ng-template>
</p-toolbar>

<!-- Tabla de solicitudes -->
<p-table
    #dt
    [value]="solicitudes()"
    [rows]="10"
    [paginator]="true"
    [globalFilterFields]="['id', 'n_credito', 'cliente', 'fecha', 'monto', 'plazo', 'v_gerencia']"
    [tableStyle]="{ 'min-width': '75rem' }"
    [rowHover]="true"
    dataKey="id"
    currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} solicitudes"
    [showCurrentPageReport]="true"
    [rowsPerPageOptions]="[10, 20, 30]"
    [loading]="loading"
>
    <ng-template pTemplate="caption">
        <div class="flex items-center justify-between">
            <h5 class="m-0">Solicitudes Registradas</h5>
            <p-iconfield>
                <p-inputicon styleClass="pi pi-search" />
                <input pInputText type="text" placeholder="Buscar..." />
            </p-iconfield>
        </div>
    </ng-template>
    <ng-template pTemplate="header">
        <tr>
            <th pSortableColumn="n_credito">N° Crédito <p-sortIcon field="n_credito"></p-sortIcon></th>
            <th pSortableColumn="cliente">Cliente <p-sortIcon field="cliente"></p-sortIcon></th>
            <th pSortableColumn="fecha">Fecha <p-sortIcon field="fecha"></p-sortIcon></th>
            <th pSortableColumn="monto">Monto <p-sortIcon field="monto"></p-sortIcon></th>
            <th pSortableColumn="plazo">Plazo <p-sortIcon field="plazo"></p-sortIcon></th>
            <th pSortableColumn="v_gerencia">V° Gerencia <p-sortIcon field="v_gerencia"></p-sortIcon></th>
            <th>Acciones</th>
        </tr>
    </ng-template>
    <ng-template pTemplate="body" let-solicitud>
        <tr class="solicitud-row" [style.border-left]="'4px solid ' + getColorBarra(solicitud)">
            <td>{{solicitud.n_credito}}</td>
            <td>{{solicitud.cliente}}</td>
            <td>{{solicitud.fecha}}</td>
            <td>{{solicitud.monto | currency:'S/ '}}</td>
            <td>{{solicitud.plazo}}</td>
            <td>
                <div class="v-gerencia-container">
                    <!-- Tag principal del estado -->
                    <div class="estado-tag-wrapper">
                        <p-tag
                            *ngIf="solicitud.v_gerencia"
                            [value]="getEstadoLabel(solicitud.v_gerencia)"
                            [severity]="getEstadoSeverity(solicitud.v_gerencia)"
                            [icon]="getEstadoIcon(solicitud.v_gerencia)"
                            [rounded]="true"
                            class="estado-tag"
                        />

                        <!-- Tag sin estado -->
                        <p-tag
                            *ngIf="!solicitud.v_gerencia"
                            value="Pendiente"
                            severity="secondary"
                            icon="pi pi-clock"
                            [rounded]="true"
                            class="estado-tag"
                        />
                    </div>

                    <!-- Botón para cambiar estado -->
                    <p-button
                        #estadoButton
                        icon="pi pi-pencil"
                        [rounded]="true"
                        [text]="true"
                        size="small"
                        severity="secondary"
                        class="estado-edit-btn"
                        (click)="estadoPanel.toggle($event, estadoButton.el.nativeElement); solicitudMenuAbierto = solicitud"
                        pTooltip="Cambiar estado"
                        tooltipPosition="top"
                    />

                    <!-- Menu overlay para cambiar estado -->
                    <p-overlayPanel
                        #estadoPanel
                        [style]="{'width': '250px'}"
                        styleClass="estado-overlay"
                    >
                        <div class="estado-menu">
                            <div class="estado-menu-header">
                                <div class="flex align-items-center gap-2 mb-2">
                                    <i class="pi pi-cog text-primary"></i>
                                    <h6 class="m-0 font-semibold text-900">Cambiar V° Gerencia</h6>
                                </div>
                                <p class="m-0 text-sm text-600" *ngIf="solicitudMenuAbierto">
                                    <i class="pi pi-file mr-1"></i>
                                    Solicitud N° {{ solicitudMenuAbierto.n_credito }}
                                </p>
                            </div>
                            <div class="estado-opciones">
                                <div
                                    *ngFor="let estado of estadosVBGerencia"
                                    class="estado-opcion"
                                    [ngClass]="{'selected': solicitudMenuAbierto?.v_gerencia === estado.value}"
                                    (click)="cambiarEstado(solicitudMenuAbierto!, estado.value, estadoPanel)"
                                >
                                    <div class="estado-opcion-content">
                                        <i [class]="getEstadoIcon(estado.value)" [style.color]="getEstadoColor(estado.value)"></i>
                                        <span class="estado-label">{{ estado.label }}</span>
                                        <i *ngIf="solicitudMenuAbierto?.v_gerencia === estado.value" class="pi pi-check ml-auto text-primary estado-check"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </p-overlayPanel>
                </div>
            </td>
            <td>
                <div class="flex gap-2 align-items-center">
                    <!-- Botón Ver -->
                    <p-button
                        icon="pi pi-eye"
                        severity="help"
                        [rounded]="true"
                        [outlined]="true"
                        (click)="viewSolicitud(solicitud)"
                        pTooltip="Ver solicitud"
                        tooltipPosition="top"
                        size="small"
                    />

                    <!-- Tag de Evaluación con PrimeNG -->
                    <p-tag
                        [value]="getLabelEvaluacion(solicitud)"
                        [severity]="getColorBotonEvaluacion(solicitud)"
                        [icon]="getIconoBotonEvaluacion(solicitud)"
                        (click)="abrirDialogoEvaluacion(solicitud)"
                        [pTooltip]="getTooltipEvaluacion(solicitud)"
                        tooltipPosition="top"
                        class="evaluacion-tag cursor-pointer"
                    />

                    <!-- Menú de Acciones Mejorado -->
                    <p-button
                        #accionesButton
                        icon="pi pi-cog"
                        severity="secondary"
                        [rounded]="true"
                        [outlined]="true"
                        (click)="accionesPanel.toggle($event, accionesButton.el.nativeElement); solicitudMenuAcciones = solicitud"
                        pTooltip="Acciones"
                        tooltipPosition="top"
                        class="acciones-btn-grande"
                    />

                    <!-- Panel de Acciones -->
                    <p-overlayPanel
                        #accionesPanel
                        [style]="{'width': '200px'}"
                        styleClass="acciones-overlay"
                    >
                        <div class="acciones-menu">
                            <div class="acciones-header">
                                <div class="flex align-items-center gap-2 mb-2">
                                    <i class="pi pi-cog text-primary"></i>
                                    <h6 class="m-0 font-semibold text-900">Acciones</h6>
                                </div>
                                <p class="m-0 text-sm text-600" *ngIf="solicitudMenuAcciones">
                                    <i class="pi pi-file mr-1"></i>
                                    Solicitud N° {{ solicitudMenuAcciones.n_credito }}
                                </p>
                            </div>
                            <div class="acciones-opciones">
                                <!-- Opción Editar -->
                                <div
                                    class="accion-opcion"
                                    (click)="editSolicitud(solicitudMenuAcciones!); accionesPanel.hide()"
                                >
                                    <div class="accion-content">
                                        <i class="pi pi-pencil text-blue-500"></i>
                                        <span class="accion-label">Editar</span>
                                        <i class="pi pi-angle-right ml-auto text-400"></i>
                                    </div>
                                </div>

                                <!-- Separador -->
                                <div class="accion-separador"></div>

                                <!-- Opción Eliminar -->
                                <div
                                    class="accion-opcion danger"
                                    (click)="confirmarEliminarSolicitud(solicitudMenuAcciones!); accionesPanel.hide()"
                                >
                                    <div class="accion-content">
                                        <i class="pi pi-trash text-red-500"></i>
                                        <span class="accion-label">Eliminar</span>
                                        <i class="pi pi-angle-right ml-auto text-400"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </p-overlayPanel>
                </div>
            </td>
        </tr>
    </ng-template>
    <ng-template pTemplate="emptymessage">
        <tr>
            <td colspan="7" class="text-center p-4">No se encontraron solicitudes.</td>
        </tr>
    </ng-template>
</p-table>

<!-- Diálogo para nueva solicitud -->
<p-dialog
    [(visible)]="displaySolicitudDialog"
    [modal]="true"
    [draggable]="false"
    [resizable]="false"
    [style]="{width: '100vw', height: '100vh', maxWidth: '100vw', maxHeight: '100vh'}"
    [contentStyle]="{overflow: 'auto'}"
    [closable]="true"
    (onHide)="hideDialog()"
>
    <app-solicitud-panel
        *ngIf="displaySolicitudDialog && selectedSolicitud"
        [solicitud]="selectedSolicitud!"
        (switchMessage)="handleSwitchMessage($event)"
    />
</p-dialog>

<!-- Diálogo para aplicar evaluación específica -->
<p-dialog
    [header]="getTituloEvaluacion()"
    [(visible)]="mostrarDialogoEvaluacion"
    [modal]="true"
    [draggable]="false"
    [resizable]="false"
    [style]="{width: '500px'}"
    [closable]="true"
    (onHide)="cerrarDialogoEvaluacion()"
>
    <div class="evaluacion-dialog" [ngClass]="getClaseEvaluacion()">
        <!-- Header con información de la solicitud -->
        <div class="solicitud-info mb-4" *ngIf="solicitudSeleccionadaEvaluacion">
            <div class="solicitud-header p-3 border-round"
                 [style.background-color]="getColorFondoHeader()"
                 [style.border]="'2px solid ' + getColorBordeHeader()">
                <h5 class="m-0 mb-2 font-bold" [style.color]="getColorEvaluacion()">
                    <i [class]="getIconoEvaluacion()" class="mr-2"></i>
                    {{ getNombreEvaluacion() }} - Solicitud N° {{ solicitudSeleccionadaEvaluacion.n_credito }}
                </h5>
                <div class="grid grid-cols-2 gap-3 text-sm">
                    <div>
                        <span class="text-600">Cliente:</span>
                        <div class="font-semibold text-900">{{ solicitudSeleccionadaEvaluacion.cliente }}</div>
                    </div>
                    <div>
                        <span class="text-600">Monto:</span>
                        <div class="font-semibold text-900">{{ solicitudSeleccionadaEvaluacion.monto | currency:'S/ ' }}</div>
                    </div>
                    <div>
                        <span class="text-600">Plazo:</span>
                        <div class="font-semibold text-900">{{ solicitudSeleccionadaEvaluacion.plazo }}</div>
                    </div>
                    <div>
                        <span class="text-600">Actividad:</span>
                        <div class="font-semibold text-900">{{ getActividadEconomica() }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Información del tipo de evaluación -->
        <div class="evaluacion-info-card mb-4" [style.border-color]="getColorEvaluacion()">
            <div class="flex align-items-center gap-3 mb-3">
                <div class="icono-evaluacion p-3 border-round"
                     [style.background-color]="getColorFondoHeader()"
                     [style.border]="'2px solid ' + getColorEvaluacion()">
                    <i [class]="getIconoEvaluacion()" class="text-2xl" [style.color]="getColorEvaluacion()"></i>
                </div>
                <div>
                    <h6 class="m-0 font-bold" [style.color]="getColorEvaluacion()">{{ getNombreEvaluacion() }}</h6>
                    <p class="m-0 text-sm text-600">{{ getDescripcionEvaluacion() }}</p>
                </div>
            </div>

            <div class="evaluacion-caracteristicas">
                <h6 class="text-900 mb-2 font-semibold">Esta evaluación incluye:</h6>
                <ul class="text-sm text-700 m-0 pl-4">
                    <li *ngFor="let caracteristica of getCaracteristicasEvaluacion()">{{ caracteristica }}</li>
                </ul>
            </div>
        </div>

        <!-- Botones de acción -->
        <div class="flex justify-end gap-3">
            <p-button
                label="Cancelar"
                severity="secondary"
                [outlined]="true"
                (click)="cerrarDialogoEvaluacion()"
            />
            <p-button
                [label]="'Aplicar ' + getNombreEvaluacion()"
                [icon]="getIconoEvaluacion()"
                [severity]="getSeveridadBoton()"
                iconPos="left"
                (click)="aplicarEvaluacion()"
            />
        </div>
    </div>
</p-dialog>

<p-confirmdialog [style]="{ width: '450px' }" />